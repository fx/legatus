<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gatus Status</title>
    <link rel="stylesheet" href="/styles.css" />
    <script src="/lib/htmx.min.js"></script>
    <script src="/lib/mustache.min.js"></script>
    <script src="/lib/client-side-templates.js"></script>
    <script>
      // Theme toggle initialization
      (function() {
        const stored = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = stored || (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>
  </head>
  <body>
    <!-- Theme toggle button -->
    <button type="button" class="theme-toggle" aria-label="Toggle theme" onclick="toggleTheme()">
      <span class="theme-icon-light">&#9788;</span>
      <span class="theme-icon-dark">&#9790;</span>
    </button>

    <!-- Mustache template for endpoints -->
    <template id="endpoints-template">
      <div class="main-container">
        <!-- Header with title and totals -->
        <div class="status-header">
          <h1 class="status-title">Service Status</h1>
          <div class="status-meta">
            <div class="status-totals">
              <span class="status-total"><span class="status-total-dot healthy"></span> {{healthyCount}}</span>
              <span class="status-total"><span class="status-total-dot unhealthy"></span> {{unhealthyCount}}</span>
              <span class="status-total"><span class="status-total-dot unknown"></span> {{unknownCount}}</span>
            </div>
            <span>Last check: {{lastChecked}}</span>
          </div>
        </div>

        <!-- Grid of status squares -->
        <div class="status-grid-container">
          <div class="status-grid">
            {{#endpoints}}
            <button
              type="button"
              class="status-square status-{{statusClass}}"
              aria-label="{{name}}{{#group}} ({{group}}){{/group}}: {{statusLabel}}"
              data-endpoint-index="{{index}}"
            ></button>
            {{/endpoints}}
          </div>
        </div>

        <!-- Detail panel (hidden by default) -->
        <div id="detail-panel" class="detail-panel" hidden>
          <div class="detail-panel-header">
            <div>
              <h3 class="detail-panel-name" id="detail-name"></h3>
              <p class="detail-panel-group" id="detail-group"></p>
            </div>
            <span class="status-badge" id="detail-badge"></span>
          </div>
          <div class="detail-panel-content" id="detail-content"></div>
        </div>

        <!-- Issues list (non-healthy services) -->
        {{#hasIssues}}
        <div class="issues-container">
          {{#hasUnhealthy}}
          <div class="issues-section">
            <div class="issues-header issues-header-unhealthy">
              <span class="issues-icon">&#9888;</span>
              Unhealthy ({{unhealthyCount}})
            </div>
            <ul class="issues-list">
              {{#unhealthyEndpoints}}
              <li class="issues-item" data-endpoint-index="{{index}}">
                <span>
                  <span class="issues-name">{{name}}</span>
                  {{#group}}<span class="issues-group">({{group}})</span>{{/group}}
                </span>
                <span class="issues-details">{{#httpStatus}}HTTP {{httpStatus}} Â· {{/httpStatus}}{{formattedTimestamp}}</span>
              </li>
              {{/unhealthyEndpoints}}
            </ul>
          </div>
          {{/hasUnhealthy}}
          {{#hasUnknown}}
          <div class="issues-section">
            <div class="issues-header issues-header-unknown">
              <span class="issues-icon">&#63;</span>
              Unknown ({{unknownCount}})
            </div>
            <ul class="issues-list">
              {{#unknownEndpoints}}
              <li class="issues-item" data-endpoint-index="{{index}}">
                <span>
                  <span class="issues-name">{{name}}</span>
                  {{#group}}<span class="issues-group">({{group}})</span>{{/group}}
                </span>
                <span class="issues-details">No data available</span>
              </li>
              {{/unknownEndpoints}}
            </ul>
          </div>
          {{/hasUnknown}}
        </div>
        {{/hasIssues}}
      </div>
    </template>

    <!-- Main container with HTMX -->
    <div
      id="app"
      hx-ext="client-side-templates"
      hx-get="/api/v1/endpoints/statuses"
      hx-trigger="load, every 30s"
      mustache-template="endpoints-template"
    >
      <div class="loading-container">
        <div class="loading-spinner"></div>
      </div>
    </div>

    <script type="module" src="/dist/app.js"></script>
    <script>
      function toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
      }

      // Detail panel functionality
      function showDetailPanel(endpoint) {
        const panel = document.getElementById('detail-panel');
        const nameEl = document.getElementById('detail-name');
        const groupEl = document.getElementById('detail-group');
        const badgeEl = document.getElementById('detail-badge');
        const contentEl = document.getElementById('detail-content');

        if (!panel || !endpoint) return;

        nameEl.textContent = endpoint.name;
        groupEl.textContent = endpoint.group || '';
        groupEl.style.display = endpoint.group ? 'block' : 'none';

        badgeEl.textContent = endpoint.statusLabel;
        badgeEl.className = 'status-badge status-badge-' + endpoint.statusClass;

        let html = '';
        if (endpoint.hasResult) {
          html += '<div class="detail-row"><span class="detail-label">Response</span><span class="detail-value">' + endpoint.formattedDuration + '</span></div>';
          if (endpoint.httpStatus) {
            html += '<div class="detail-row"><span class="detail-label">HTTP Status</span><span class="detail-value">' + endpoint.httpStatus + '</span></div>';
          }
          html += '<div class="detail-row"><span class="detail-label">Last Check</span><span class="detail-value">' + endpoint.formattedTimestamp + '</span></div>';

          if (endpoint.hasConditions && endpoint.conditions && endpoint.conditions.length > 0) {
            html += '<div class="detail-conditions"><div class="detail-conditions-title">Conditions</div><ul class="detail-conditions-list">';
            endpoint.conditions.forEach(function(c) {
              html += '<li class="detail-condition-item"><span class="' + c.iconClass + '">' + c.icon + '</span><code class="detail-condition-code">' + c.condition + '</code></li>';
            });
            html += '</ul></div>';
          }
        } else {
          html = '<p style="color: var(--muted-color); font-style: italic;">No health check results available</p>';
        }

        contentEl.innerHTML = html;
        panel.hidden = false;
      }

      function clearSelection() {
        document.querySelectorAll('.status-square.selected, .issues-item.selected').forEach(function(el) {
          el.classList.remove('selected');
        });
      }

      // Set up click handlers after HTMX swap
      document.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id !== 'app') return;

        const endpoints = window.__endpoints || [];

        // Click handler for squares
        document.querySelectorAll('.status-square[data-endpoint-index]').forEach(function(square) {
          square.addEventListener('click', function() {
            const index = parseInt(this.dataset.endpointIndex, 10);
            const endpoint = endpoints[index];
            if (endpoint) {
              clearSelection();
              this.classList.add('selected');
              showDetailPanel(endpoint);
            }
          });
        });

        // Click handler for issues list items
        document.querySelectorAll('.issues-item[data-endpoint-index]').forEach(function(item) {
          item.addEventListener('click', function() {
            const index = parseInt(this.dataset.endpointIndex, 10);
            const endpoint = endpoints[index];
            if (endpoint) {
              clearSelection();
              this.classList.add('selected');
              showDetailPanel(endpoint);
            }
          });
        });
      });
    </script>
  </body>
</html>
